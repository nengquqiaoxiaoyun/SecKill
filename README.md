# SecKill
[慕课SpringBoot秒杀项目](https://www.imooc.com/learn/1079)

# 第二章

[Mybatis自动生成器](./Mybatis-Generator.md)

# 第三章

[定义通用的返回对象](./定义通用返回对象.md)

## 用户注册

controller

将前端的属性用实体类接收，实体类字段明和前端的参数必须一致，实体类没有的参数单个接收

数据库的用户实体对用`UserDO`，我们把前端接收的参数传给Service，**Service把实体转为DO后给Mapper处理**

```java
    /**
     * {@code @RequestBody }只能接受json格式，
     * 如果前端没有明确规定{@code Content-Type: "application/json"}则会报错
     * ajax不规定格式的话默认 Content-Type: "application/x-www-form-urlencoded"
     */
    @PostMapping(value = "/register")
    public CommonReturnType register(UserDto userDto, @RequestParam("otpCode") String otpCode) throws BussinesssError {

        String inSessionOtpCode = (String) request.getSession().getAttribute(userDto.getTelephone());
        if (!StringUtils.equals(otpCode, inSessionOtpCode)) {
             throw new BussinesssError(ErrorEnum.PARAMTER_VALIDATION_ERROR, "otp验证失败");
        }

        userService.register(userDto);

        return CommonReturnType.create(null);
    }
```

```javascript
 $.ajax({
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                url: "http://localhost:8081/user/register",
                data: {
                    "telephone": telphone,
                    "otpCode": otpCode,
                    "name": name,
                    "gender": gender,
                    "age": age,
                    "encryptPassword": password
                },
                success: function (data) {
                    if (data.status == "success") {
                        alert("注册成功");
                    } else {
                        alert("注册失败，原因为" + data.data.errMsg);
                    }
                },
                error: function (data) {
                    alert("otp发送失败，原因为," + data.responseText);
                }
            })
```

service

注意点：

1. 事务
2.  userDO的id可能为空，因为采用的insertSelective方法，如果没有在xml中设置主键自增则插入的数据UserDo不会有id

```xml
 <!-- 开启keyProperty和主键自增 会将id赋值给UserPasswordDO -->
    <insert id="insertSelective" parameterType="com.huakai.mapper.dataobject.UserDO" keyProperty="id"
            useGeneratedKeys="true">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Aug 30 14:58:59 CST 2021.
        -->
        insert into user_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="name != null">
                name,
            </if>
            <if test="gender != null">
                gender,
            </if>
            <if test="age != null">
                age,
            </if>
            <if test="telephone != null">
                telephone,
            </if>
            <if test="registerMode != null">
                register_mode,
            </if>
            <if test="thirdPartId != null">
                third_part_id,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="name != null">
                #{name,jdbcType=VARCHAR},
            </if>
            <if test="gender != null">
                #{gender,jdbcType=TINYINT},
            </if>
            <if test="age != null">
                #{age,jdbcType=INTEGER},
            </if>
            <if test="telephone != null">
                #{telephone,jdbcType=VARCHAR},
            </if>
            <if test="registerMode != null">
                #{registerMode,jdbcType=VARCHAR},
            </if>
            <if test="thirdPartId != null">
                #{thirdPartId,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
```

3. 加密时不能简单地使用Java自带的MD5，其只支持16位

```java
    @Override
    @Transactional
    public void register(UserDto userDto) {

        UserDO userDO = converUerDto(userDto);
        // insert to user_info
        userDOMapper.insertSelective(userDO);

        /*
         此处需要注意两点：
         1. userDO的id可能为空，因为采用的insertSelective方法
         如果没有在xml中设置主键自增则插入的数据UserDo不会有id
         2. 加密时不能简单地使用Java自带的MD5，其只支持16位
         */
        UserPasswordDO userPasswordDO = new UserPasswordDO();
        userPasswordDO.setUserId(userDO.getId());
        userPasswordDO.setEncryptPassword(encodeByMyd(userDto.getEncryptPassword()));
        // insert to user_password
        userPasswordDOMapper.insertSelective(userPasswordDO);
    }
```

## 跨域session共享问题

注意：前后端不分离的项目不会产生此问题

session已经设置，但是register时却获取不到

原因：CrossOrigin跨域无法做到session共享，注意SpringBoot版本可能需要不同的处理方式

```java
// SpringBoot 2.5.2
@CrossOrigin(allowCredentials = "true", originPatterns = "*")
```

较早版本

```java
@CrossOrigin(allowCredentials = "true", allowedHeaders = "*")
```

这将允许跨域传输所有的header参数，将用于使用token放入header，做session共享的跨域请求

同时前端发送ajax请求需要指定`xhrFields`参数，意思是允许跨域的授信请求，使其session跨域可授信

```javascript
xhrFields: {withCredentials: true}
```

