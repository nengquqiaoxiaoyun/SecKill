# SecKill
[慕课SpringBoot秒杀项目](https://www.imooc.com/learn/1079)

# 第二章

[Mybatis自动生成器](./Mybatis-Generator.md)

# 第三章

[定义通用的返回对象](./定义通用返回对象.md)

## 用户注册

controller

将前端的属性用实体类接收，实体类字段明和前端的参数必须一致，实体类没有的参数单个接收

数据库的用户实体对用`UserDO`，我们把前端接收的参数传给Service，**Service把实体转为DO后给Mapper处理**

```java
    /**
     * {@code @RequestBody }只能接受json格式，
     * 如果前端没有明确规定{@code Content-Type: "application/json"}则会报错
     * ajax不规定格式的话默认 Content-Type: "application/x-www-form-urlencoded"
     */
    @PostMapping(value = "/register")
    public CommonReturnType register(UserDto userDto, @RequestParam("otpCode") String otpCode) throws BussinesssError {

        String inSessionOtpCode = (String) request.getSession().getAttribute(userDto.getTelephone());
        if (!StringUtils.equals(otpCode, inSessionOtpCode)) {
             throw new BussinesssError(ErrorEnum.PARAMTER_VALIDATION_ERROR, "otp验证失败");
        }

        userService.register(userDto);

        return CommonReturnType.create(null);
    }
```

```javascript
 $.ajax({
                type: "POST",
                contentType: "application/x-www-form-urlencoded",
                url: "http://localhost:8081/user/register",
                data: {
                    "telephone": telphone,
                    "otpCode": otpCode,
                    "name": name,
                    "gender": gender,
                    "age": age,
                    "encryptPassword": password
                },
                success: function (data) {
                    if (data.status == "success") {
                        alert("注册成功");
                    } else {
                        alert("注册失败，原因为" + data.data.errMsg);
                    }
                },
                error: function (data) {
                    alert("otp发送失败，原因为," + data.responseText);
                }
            })
```

service

注意点：

1. 事务
2.  userDO的id可能为空，因为采用的insertSelective方法，如果没有在xml中设置主键自增则插入的数据UserDo不会有id

```xml
 <!-- 开启keyProperty和主键自增 会将id赋值给UserPasswordDO -->
    <insert id="insertSelective" parameterType="com.huakai.mapper.dataobject.UserDO" keyProperty="id"
            useGeneratedKeys="true">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Aug 30 14:58:59 CST 2021.
        -->
        insert into user_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="name != null">
                name,
            </if>
            <if test="gender != null">
                gender,
            </if>
            <if test="age != null">
                age,
            </if>
            <if test="telephone != null">
                telephone,
            </if>
            <if test="registerMode != null">
                register_mode,
            </if>
            <if test="thirdPartId != null">
                third_part_id,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="name != null">
                #{name,jdbcType=VARCHAR},
            </if>
            <if test="gender != null">
                #{gender,jdbcType=TINYINT},
            </if>
            <if test="age != null">
                #{age,jdbcType=INTEGER},
            </if>
            <if test="telephone != null">
                #{telephone,jdbcType=VARCHAR},
            </if>
            <if test="registerMode != null">
                #{registerMode,jdbcType=VARCHAR},
            </if>
            <if test="thirdPartId != null">
                #{thirdPartId,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
```

3. 加密时不能简单地使用Java自带的MD5，其只支持16位

```java
    @Override
    @Transactional
    public void register(UserDto userDto) {

        UserDO userDO = converUerDto(userDto);
        // insert to user_info
        userDOMapper.insertSelective(userDO);

        /*
         此处需要注意两点：
         1. userDO的id可能为空，因为采用的insertSelective方法
         如果没有在xml中设置主键自增则插入的数据UserDo不会有id
         2. 加密时不能简单地使用Java自带的MD5，其只支持16位
         */
        UserPasswordDO userPasswordDO = new UserPasswordDO();
        userPasswordDO.setUserId(userDO.getId());
        userPasswordDO.setEncryptPassword(encodeByMyd(userDto.getEncryptPassword()));
        // insert to user_password
        userPasswordDOMapper.insertSelective(userPasswordDO);
    }
```

## 跨域session共享问题

注意：前后端不分离的项目不会产生此问题

session已经设置，但是register时却获取不到

原因：CrossOrigin跨域无法做到session共享，注意SpringBoot版本可能需要不同的处理方式

```java
// SpringBoot 2.5.2
@CrossOrigin(allowCredentials = "true", originPatterns = "*")
```

较早版本

```java
@CrossOrigin(allowCredentials = "true", allowedHeaders = "*")
```

这将允许跨域传输所有的header参数，将用于使用token放入header，做session共享的跨域请求

同时前端发送ajax请求需要指定`xhrFields`参数，意思是允许跨域的授信请求，使其session跨域可授信

```javascript
xhrFields: {withCredentials: true}
```

## 参数校验

在需要使用的地方注入ValidatorImpl，调用valite方法进行校验。这样的方式只能对实体进行校验，实体需要加上相应的注解

```java
 ValidationResult validate = validator.validate(userDto);
        if(validate.isHasErrors())
            throw new BussinesssError(ErrorEnum.PARAMTER_VALIDATION_ERROR, validate.getErrMsg());
```

UserDTO

```java
    @NotBlank(message = "用户名不能为空")
    private String name;

    private Byte gender;

    @Min(value = 0, message = "年龄过小")
    @Max(value = 150, message = "年龄过大")
    private Integer age;

    @NotBlank(message = "手机不能为空")
    @Pattern(regexp = "(?:(?:\\+|00)86)?1(?:(?:3[\\d])|(?:4[5-79])|(?:5[0-35-9])|(?:6[5-7])|(?:7[0-8])|(?:8[\\d])|(?:9[189]))\\d{8}", message = "请输入正确的手机号")
    private String telephone;
```

添加依赖

```java
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
```

ValidationResult

```java
package com.huakai.valiator;

import org.apache.commons.lang3.StringUtils;

import java.util.HashMap;
import java.util.Map;

/**
 * @author: huakaimay
 * @since: 2021-09-01
 */
public class ValidationResult {
    /**
     * 校验结果是否有错
     */
    private boolean hasErrors = false;

    /**
     * 存放错误信息的map
     */
    private Map<String, String> errorMsgMap = new HashMap<>();

    public boolean isHasErrors() {
        return hasErrors;
    }

    /**
     * 实现通用的通过格式化字符串信息获取错误结果的msg方法
     */
    public String getErrMsg() {
        return StringUtils.join(errorMsgMap.values().toArray(), ",");
    }


    public void setHasErrors(boolean hasErrors) {
        this.hasErrors = hasErrors;
    }

    public Map<String, String> getErrorMsgMap() {
        return errorMsgMap;
    }

    public void setErrorMsgMap(Map<String, String> errorMsgMap) {
        this.errorMsgMap = errorMsgMap;
    }
}
```

ValidatorImpl

```java
package com.huakai.valiator;

import org.springframework.beans.factory.InitializingBean;
import org.springframework.stereotype.Component;

import javax.validation.ConstraintViolation;
import javax.validation.Validation;
import javax.validation.Validator;
import java.util.Set;

/**
 * @author: huakaimay
 * @since: 2021-09-01
 */
@Component
public class ValidatorImpl implements InitializingBean {


    private Validator validator;

    public ValidationResult validate(Object bean) {
        ValidationResult result = new ValidationResult();
        Set<ConstraintViolation<Object>> constraintViolationSet = validator.validate(bean);
        // 有参数说明有错误
        if (constraintViolationSet.size() > 0) {
            result.setHasErrors(true);
            constraintViolationSet.forEach(constraintViolation -> {
                String propertyName = constraintViolation.getPropertyPath().toString();
                String errMsg = constraintViolation.getMessage();
                result.getErrorMsgMap().put(propertyName, errMsg);
            });
        }
        return result;
    }

    @Override
    public void afterPropertiesSet() throws Exception {
        // 初始化validator
        this.validator = Validation.buildDefaultValidatorFactory().getValidator();
    }

}
```

